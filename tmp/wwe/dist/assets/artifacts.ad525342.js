var e=Object.defineProperty,a=Object.prototype.hasOwnProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.propertyIsEnumerable,l=(a,t,s)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,r=(e,r)=>{for(var o in r||(r={}))a.call(r,o)&&l(e,o,r[o]);if(t)for(var o of t(r))s.call(r,o)&&l(e,o,r[o]);return e};import{_ as o}from"./V-Breadcrumb.vue_vue&type=script&setup=true&lang.95222eda.js";import{_ as i,a as c}from"./V-Field.vue_vue&type=script&setup=true&lang.50df6a27.js";import{_ as n}from"./V-Button.vue_vue&type=script&setup=true&lang.7d7c3fd2.js";import{_ as d}from"./V-FlexNone.vue_vue&type=script&setup=true&lang.cbed393c.js";import{t as u}from"./filters.e49d41fb.js";import{a as p,c as m,d as v,u as f}from"./index.670b29b2.js";import{d as b,j as h,k as g,S as j,F as y,i as _,Q as k,n as x,U as w,u as V,P as z,r as C,v as O,b as S,a as E,W as P,m as R,A as q,z as A,X as N,E as U,O as F}from"./vendor.6243191d.js";import{_ as B}from"./V-FlexTable.vue_vue&type=script&setup=true&lang.19fc13e5.js";import{_ as I}from"./V-Modal.vue_vue&type=script&setup=true&lang.13c249d1.js";import{u as L}from"./useNotyf.8c9a8697.js";import{_ as T}from"./V-Loader.vue_vue&type=script&setup=true&lang.152a1df5.js";import{a as $,t as D}from"./activeSidebarState.4b53b430.js";import"./V-PlaceholderSection.vue_vue&type=script&setup=true&lang.67c36c04.js";import"./moment.08a7f518.js";const M={class:"flex-table-cell","data-th":"Name"},X={class:"flex-table-cell","data-th":"Email"},H={class:"flex-table-cell","data-th":"Title"},J={class:"flex-table-cell cell-end"},Q={class:"buttons"},W=x("span",{class:"icon is-small"},[x("i",{class:"iconify","data-icon":"feather:download-cloud"})],-1),G=x("span",{class:"icon is-small"},[x("i",{class:"iconify","data-icon":"feather:tag"})],-1);var K=b({expose:[],props:{rows:{type:Array,required:!0}},setup(e){const a=p();m();const t=_("handleRelease"),s=(e,t,s)=>{const l=new XMLHttpRequest;l.open("get",`/api/projects/${a.params.projectid}/jobs/${t}/artifacts/${s}`,!0),l.responseType="blob",l.setRequestHeader("X-Token",localStorage.getItem("token")),l.onload=function(){if(200===this.status){const e=this.response,a=new FileReader;a.readAsDataURL(e),a.onload=function(e){const a=document.createElement("a");a.download=s,a.href=e.target.result;const t=document.createEvent("MouseEvents");t.initEvent("click",!0,!0),a.dispatchEvent(t)}}},l.send()};return(a,l)=>{const r=k("tooltip");return h(!0),g(y,null,j(e.rows,(e=>(h(),g("div",{key:e.id,class:"flex-table-item"},[x("div",M,w(e.name),1),x("div",X,w(e.build_num),1),x("div",H,w(V(u)(e.create_time)),1),x("div",J,[x("div",Q,[z(x("button",{onClick:a=>s(e.project_id,e.build_num,e.name),class:"button is-dark-outlined is-circle"},[W],8,["onClick"]),[[r,"下载",void 0,{bottom:!0,right:!0,rounded:!0}]]),z(x("button",{onClick:a=>V(t)(e),class:"button is-dark-outlined is-circle"},[G],8,["onClick"]),[[r,"发版",void 0,{bottom:!0,right:!0,rounded:!0}]])])])])))),128)}}});const Y={key:0},Z={class:"list-view-toolbar"},ee={class:"buttons"},ae={class:"page-content-inner"},te=x("div",{class:"flex-table-header"},[x("span",null,"名称"),x("span",null,"构建编号"),x("span",null,"时间"),x("span",{class:"cell-end"},"操作")],-1),se={class:"field is-horizontal"},le=x("div",{class:"field-label is-normal"},[x("label",{class:"label required"},"名称")],-1),re={class:"field-body"},oe={class:"field is-horizontal"},ie=x("div",{class:"field-label is-normal"},[x("label",{class:"label required"},"版本")],-1),ce={class:"field-body"},ne={class:"field is-horizontal"},de=x("div",{class:"field-label is-normal"},[x("label",{class:"label"},"描述")],-1),ue={class:"field-body"},pe=U("确定");var me=b({expose:[],props:{audit:{type:Boolean,default:!1}},setup(e){const{audit:a}=e,t=p(),s=m(),l=v(),o=L(),u=C(!1);C();const f=C(""),b=O((()=>{try{return Number.parseInt(t.query.page)||1}catch(e){}return 1})),j=S({project_id:t.params.projectid,name:"",desc:"",tag:"",artifact_name:"",build_num:""});A("handleRelease",(e=>{u.value=!0,j.artifact_name=e.name,j.build_num=e.build_num})),A("isDownload",!1),C(""),E([f,b],((e,r)=>{e[0]!==r[0]&&(s.push("artifacts"),l.dispatch("user/getArtfacts",{id:t.params.projectid,page:1,size:10,search:e[0],status:a?"1":void 0})),e[1]!==r[1]&&l.dispatch("user/getArtfacts",{id:t.params.projectid,page:b.value,size:1,search:e[0],status:a?"1":void 0})}));const y=O((()=>l.state.user.artifacts));return P((()=>{l.dispatch("user/getArtfacts",{id:t.params.projectid})})),(e,a)=>{const p=c,m=i,v=n,b=d,_=K,k=B,w=I;return V(y)?(h(),g("div",Y,[x("div",Z,[x(m,null,{default:R((()=>[x(p,{icon:"feather:search"},{default:R((()=>[z(x("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>f.value=e),class:"input custom-text-filter",placeholder:"Search..."},null,512),[[N,f.value]])])),_:1})])),_:1}),x("div",ee,[q("",!0)])]),x("div",ae,[V(y)&&0===V(y).length?(h(),g(b,{key:0,title:"没有数据",subtitle:"当前没有要显示的数据"})):(h(),g(k,{key:1,compact:""},{header:R((()=>[te])),body:R((()=>[x(_,{rows:V(y)},null,8,["rows"])])),_:1}))]),x(w,{open:u.value,size:"large",actions:"center",title:"发布到稳定版本",onClose:a[6]||(a[6]=e=>(u.value=!1,j.name="",j.desc="",void(j.tag="")))},{content:R((()=>[x("div",null,[x("div",se,[le,x("div",re,[x(m,null,{default:R((()=>[x(p,null,{default:R((()=>[z(x("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>V(j).name=e),class:"input",type:"text",placeholder:"名称"},null,512),[[N,V(j).name]])])),_:1})])),_:1})])]),x("div",oe,[ie,x("div",ce,[x(m,null,{default:R((()=>[x(p,null,{default:R((()=>[z(x("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>V(j).tag=e),class:"input",type:"text",placeholder:"版本"},null,512),[[N,V(j).tag]])])),_:1})])),_:1})])]),x("div",ne,[de,x("div",ue,[x(m,null,{default:R((()=>[x(p,null,{default:R((()=>[z(x("textarea",{"onUpdate:modelValue":a[4]||(a[4]=e=>V(j).desc=e),class:"textarea",rows:"6",placeholder:"描述"},"\n                  ",512),[[N,V(j).desc]])])),_:1})])),_:1})])])])])),action:R((()=>[x(v,{color:"primary",onClick:a[5]||(a[5]=e=>(()=>{console.log("formData",j);let e=JSON.parse(JSON.stringify(l.state.user.releases)).data;""!==j.name?/\d+\.\d+\.\d+/.test(j.tag)?e[0]&&j.tag<=e[0].tag?o.error(`请输入大于${e[0].tag}的版本`):l.dispatch("user/createRelease",r(r({},j),{projectId:t.params.projectid})).then((()=>{o.success("发布成功！"),s.push({name:"user-projects-projectid-releases",params:{projectid:t.params.projectid}})})):o.error("版本信息填写错误，请填写正确的版本信息, 例如：1.0.1"):o.error("请输入版本名称")})()),raised:""},{default:R((()=>[pe])),_:1})])),_:1},8,["open"])])):q("",!0)}}});const ve={class:"page-title has-text-centered"},fe={class:"menu-toggle has-chevron"},be=x("span",{class:"rotate"},[x("i",{class:"icon-line-top"}),x("i",{class:"icon-line-center"}),x("i",{class:"icon-line-bottom"})],-1),he=x("div",{class:"title-wrap"},[x("h1",{class:"title is-4"},"制品管理")],-1),ge={class:"page-content-inner"},je={class:"breadcrumb-box"},ye=x("i",{class:"iconify","data-icon":"feather:corner-down-left"},null,-1),_e={key:0,class:"public-key-box"},ke={class:"pre-box"};var xe=b({expose:[],setup(e){const a=p(),t=m(),s=v(),l=C(!0);f({title:"制品管理"}),F((()=>{$.value="projects"}));const r=C(!1),i=O((()=>s.state.user.project)),c=C();return P((()=>{Promise.all([s.dispatch("user/getProject",a.params.projectid),s.dispatch("user/getBuilders",{id:a.params.projectid,page:1,size:10})]).then((()=>{c.value=[{icon:"feather:home",hideLabel:!0,to:{name:"user-projects"}},{label:"项目列表",to:{name:"user-projects"}},{label:i.value.repo_name,to:{name:"user-projects-projectid-files",params:{projectid:a.params.projectid}}},{label:"制品管理"}],l.value=!1}))})),(e,a)=>{const s=o,n=me,d=T,u=I;return h(),g("div",null,[x("div",ve,[x("div",{class:"vuero-hamburger nav-trigger push-resize",onClick:a[1]||(a[1]=e=>V(D)("projects"))},[x("span",fe,[x("span",{class:[["projects"===V($)&&"active"],"icon-box-toggle"]},[be],2)])]),he]),x("div",ge,[x(d,{size:"large",active:l.value},{default:R((()=>[x("div",je,[c.value?(h(),g(s,{key:0,items:c.value,separator:"bullet","with-icons":""},null,8,["items"])):q("",!0),x("div",{onClick:a[2]||(a[2]=()=>V(t).back())},[ye])]),x(n)])),_:1},8,["active"])]),x(u,{open:r.value,size:"large",actions:"center",title:"查看公钥",onClose:a[3]||(a[3]=e=>r.value=!1)},{content:R((()=>[V(i).deploy_key?(h(),g("div",_e,[x("div",ke,[x("pre",null,w(V(i).deploy_key.public_key),1)])])):q("",!0)])),action:R((()=>[])),_:1},8,["open"])])}}});export default xe;
